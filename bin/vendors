#!/usr/bin/env php
<?php

/*
 * This file is part of the Symfony Standard Edition.
 *
 * (c) Fabien Potencier <fabien@symfony.com>
 *
 * For the full copyright and license information, please view the LICENSE
 * file that was distributed with this source code.
 */

$rootDir = dirname(__DIR__);
$vendorDir = $rootDir.'/vendor';

if (!file_exists($rootDir.'/app/config/parameters.ini')) {
    copy($rootDir.'/app/config/parameters.ini.dist', $rootDir.'/app/config/parameters.ini');
    echo "NOTICE: Using default testing configuration.\n";
}

if (!is_dir($vendorDir)) {
    mkdir($vendorDir, 0777, true);
}

// php on windows can't use the shebang line from system()
$interpreter = PHP_OS == 'WINNT' ? 'php.exe' : '';

//Install Composer dependencies
system(sprintf('%s %s update', $interpreter, escapeshellarg($rootDir.'/composer.phar')));

// Update the bootstrap files
system(sprintf('%s %s %s', $interpreter, escapeshellarg($rootDir.'/vendor/sensio/distribution-bundle/Sensio/Bundle/DistributionBundle/Resources/bin/build_bootstrap.php'), escapeshellarg($rootDir)));

// Update assets
system(sprintf('%s %s assets:install %s', $interpreter, escapeshellarg($rootDir.'/app/console'), escapeshellarg($rootDir.'/web/')));

// Remove the cache
system(sprintf('%s %s cache:clear --no-warmup', $interpreter, escapeshellarg($rootDir.'/app/console')));

// Install SQLBuddy
system(sprintf('%s %s sqlbuddy:install web', $interpreter, escapeshellarg($rootDir.'/app/console')));

// Update the DB
system(sprintf('%s %s doctrine:database:create', $interpreter, escapeshellarg($rootDir.'/app/console')));
system(sprintf('%s %s doctrine:schema:update --force', $interpreter, escapeshellarg($rootDir.'/app/console')));
